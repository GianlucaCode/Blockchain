<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Interface for Trade Bot</title>

    <!-- Styles -->
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800,900|Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/main.js"></script>

  </head>
  <body>

    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <a href="index.html">Home</a>
      <a href="observation.html">Observer</a>
      <a href="#">Current ballance</a>
      <a href="#">Table of ballance</a>
      <a href="#">Log</a>

    </div>
    <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; open</span>
    <div class="container">

      <h2>Trade Bot</h2>
      <p>To make the tabs toggleable, add the data-toggle="tab" attribute to each link. Then add a .tab-pane class with a unique ID for every tab and wrap them inside a div element with class .tab-content.</p>

      <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#home">Balance graph</a></li>
        <li><a data-toggle="tab" href="#menu1">Current balances</a></li>
        <li><a data-toggle="tab" href="#menu2">Log</a></li>
        <li><a data-toggle="tab" href="#menu3">Something else</a></li>
      </ul>

      <div class="tab-content">
        <div id="home" class="tab-pane fade in active">

          <script type="text/javascript">
            process_file('balances_post.txt', prepare_json);
          </script>

          <h3>Visualized Changes</h3>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
          <div id='plot'>

          </div>
          <img id='jpg-export' src="" alt=""/>
        </div>
        <div id="menu1" class="tab-pane fade">
          <h3>Menu 1</h3>
          <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        </div>
        <div id="menu2" class="tab-pane fade">
          <h3>Menu 2</h3>
          <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam.</p>
        </div>
        <div id="menu3" class="tab-pane fade">
          <h3>Menu 3</h3>
          <p>Eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
        </div>
      </div>
    </div>
    <!-- <script type="text/javascript">

      function myplot(time, pdata) {
        let plot = document.createElement('div');
        let plottingData = [];
        let layouts = [];
        for(let key in pdata) {
          plottingData.push(
            {
              x:time,
              y:pdata[key],
              type:'lines+markers',
              name:key
            }
          )
        }

        let layout = {
          margin: {
            l: 50,
            b: 50,
            t: 5,
            r: 20
          },
          title: false,
          width: 300,
          height: 300,
          xaxis: {
            title: 'time',
            titlefont: {
              size: 10
            },
            tickfont: {
              size: 10
            }
          },
          yaxis: {
            title: 'balance, usd',
            titlefont: {
              size: 10
            },
            tickfont: {
              size: 10
            }
          },
          showlegend: true
        };



        Plotly.plot(plot, plottingData, layout).then(
          function(gd) {
            return Plotly.toImage(gd, {
              format: "svg",
              height: 600,
              width: 1000
            }).then(
              function(url) {
                let img_jpg = document.getElementById("jpg-export");
                img_jpg.src = url;
              }
            )
          });
      }

      // let file = 'balances.txt';
       let file = 'balances_expanded.txt';
      $.get(file, function(text) {
        console.log(text);
        let data = text.split('\n').map((x) => {
          let tmp = x.split('|');
          if(tmp[1] != 'Balances') return null;
          try {
            tmp[5] = JSON.parse(tmp[5].replace(/'/g, '"'));

          } catch(e) {
            console.log(e);
            console.log(tmp[5]);
            return null;
          }
          return [new Date(tmp[0]), tmp[5]];
        }
        ).filter(x => x !== null);

        for(let i = 1; i < data.length; i++) {
          for(let exch in data[i][1]) {
            for(let curr in data[i][1][exch]) {
              if(data[i][1][exch][curr] == -1) {
                data[i][1][exch][curr] = data[i - 1][1][exch][curr];
              }
            }
          }
        }

        data = data.map(x => {
          let acc = {};
          for(let exch in x[1]) {
            for(let curr in x[1][exch]) {
              if(curr in acc) {
                acc[curr] += +x[1][exch][curr];
              }
              else {
                acc[curr] = +x[1][exch][curr];
              }
            }
          }
          return [x[0], acc];
        });

        data = data.slice(Math.max(data.length - 10, 0), data.length);
        console.log(data);

        let currency_to_usd = {
          'btc': 6370, 'ltc': 80, 'bch': 707.8, 'usd': 1, 'xrp': 0.45, 'dash': 220.0, 'eth': 445.0
        }

        let points = {};
        let time = [];
        for(let i = 0; i < data.length; i++) {
          time.push(data[i][0]);
          for(key in data[i][1]) {
            if(key in points) {
              points[key].push(data[i][1][key] * currency_to_usd[key]);
            }
            else{
              points[key] = [data[i][1][key] * currency_to_usd[key]];
            }
          }
        }

        myplot(time, points);

      }
    )
    </script> -->




    <!-- Javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.0.min.js"><\/script>')</script>
    <script src="js/wow.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/util.js"></script>
    <script>
      function openNav() {
          document.getElementById("mySidenav").style.width = "250px";
          document.getElementById("main").style.marginLeft = "250px";
      }

      function closeNav() {
          document.getElementById("mySidenav").style.width = "0";
          document.getElementById("main").style.marginLeft= "0";
      }
    </script>
  </body>
</html>
